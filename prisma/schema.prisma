generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String          @id @default(cuid())
  email              String          @unique
  name               String
  password           String
  role               String          @default("STAFF")
  isActive           Boolean         @default(true)
  lastLoginAt        DateTime?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  accounts           Account[]
  activityLogs       ActivityLog[]
  assignedClients    Client[]
  sentCommunications Communication[]
  notifications      Notification[]
  sessions           Session[]
  defaultAssigneeFor UserSettings[]  @relation("DefaultAssignee")
  settings           UserSettings?

  @@index([email])
  @@index([role])
  @@index([isActive])
  @@map("users")
}

model Client {
  id                            String          @id @default(cuid())
  clientCode                    String?         @unique
  companyName                   String
  companyNumber                 String?         @unique
  companyType                   String
  companyStatus                 String?
  companyStatusDetail           String?
  incorporationDate             DateTime?
  cessationDate                 DateTime?
  registeredOfficeAddress       String?
  tradingAddress                String?
  residentialAddress            String?
  sicCodes                      String?
  nextAccountsDue               DateTime?
  lastAccountsMadeUpTo          DateTime?
  accountingReferenceDate       String?
  nextConfirmationDue           DateTime?
  lastConfirmationMadeUpTo      DateTime?
  nextCorporationTaxDue         DateTime?
  // Corporation Tax tracking fields
  corporationTaxStatus          String?         @default("PENDING") // PENDING, FILED, OVERDUE
  corporationTaxPeriodStart     DateTime?       // Start of current CT period
  corporationTaxPeriodEnd       DateTime?       // End of current CT period (year end)
  manualCTDueOverride           DateTime?       // Manual override by accountant
  ctDueSource                   String?         @default("AUTO") // AUTO, MANUAL
  lastCTStatusUpdate            DateTime?       // When CT status was last changed
  ctStatusUpdatedBy             String?         // User who updated CT status
  jurisdiction                  String?
  hasBeenLiquidated             Boolean         @default(false)
  hasCharges                    Boolean         @default(false)
  hasInsolvencyHistory          Boolean         @default(false)
  officers                      String?
  personsWithSignificantControl String?
  contactName                   String
  contactEmail                  String
  contactPhone                  String?
  contactFax                    String?
  website                       String?
  vatNumber                     String?
  yearEstablished               Int?
  numberOfEmployees             Int?
  annualTurnover                Float?
  paperworkFrequency            String?
  assignedUserId                String?
  isActive                      Boolean         @default(true)
  notes                         String?
  createdAt                     DateTime        @default(now())
  updatedAt                     DateTime        @updatedAt
  additionalComments            String?
  annualAccountingScheme        Boolean         @default(false)
  businessType                  String?
  dormantStatus                 Boolean         @default(false)
  flatRatePercentage            Float?
  jobCompleted                  Boolean         @default(false)
  jobCompletedDate              DateTime?
  nationalInsuranceNumber       String?
  natureOfTrade                 String?
  numberOfPartners              Int?
  paperWorkReceived             Boolean         @default(false)
  paperWorkReceivedDate         DateTime?
  partnershipTaxReturn          Boolean         @default(false)
  previousYearEnded             DateTime?
  previousYearJobCompletedDate  DateTime?
  previousYearSA100FiledDate    DateTime?
  previousYearWorkReceivedDate  DateTime?
  residentialAddressCountry     String?
  residentialAddressLine1       String?
  residentialAddressLine2       String?
  residentialAddressPostCode    String?
  sa100Filed                    Boolean         @default(false)
  sa100FiledDate                DateTime?
  smallCompanyExemption         Boolean         @default(false)
  staff                         String?
  tradingAddressCountry         String?
  tradingAddressLine1           String?
  tradingAddressLine2           String?
  tradingAddressPostCode        String?
  utrNumber                     String?
  vatDeregistrationDate         DateTime?
  vatFrequency                  String?
  vatQuarters                   String?
  vatRegistrationDate           DateTime?
  vatScheme                     String?
  workStatus                    String?
  // Post-creation questionnaire fields
  isVatEnabled                  Boolean         @default(false)
  vatReturnsFrequency           String?
  vatQuarterGroup               String?         // For quarterly VAT: "1_4_7_10", "2_5_8_11", "3_6_9_12"
  nextVatReturnDue              DateTime?
  requiresPayroll               Boolean         @default(false)
  requiresBookkeeping           Boolean         @default(false)
  requiresManagementAccounts    Boolean         @default(false)
  preferredContactMethod        String?
  specialInstructions           String?
  // Service management fields
  handlesAnnualAccounts         Boolean         @default(true)  // Whether we handle their annual accounts
  activityLogs                  ActivityLog[]
  assignedUser                  User?           @relation(fields: [assignedUserId], references: [id])
  communications                Communication[]

  @@index([companyNumber])
  @@index([assignedUserId])
  @@index([isActive])
  @@index([companyType])
  @@index([companyStatus])
  @@index([nextAccountsDue])
  @@index([nextConfirmationDue])
  @@index([nextCorporationTaxDue])
  @@index([corporationTaxStatus])
  @@index([corporationTaxPeriodEnd])
  @@index([ctDueSource])
  @@map("clients")
}

model Communication {
  id           String    @id @default(cuid())
  type         String
  subject      String
  content      String
  sentAt       DateTime?
  scheduledAt  DateTime?
  clientId     String
  sentByUserId String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  client       Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  sentBy       User?     @relation(fields: [sentByUserId], references: [id])

  @@index([clientId])
  @@index([sentByUserId])
  @@index([type])
  @@index([sentAt])
  @@map("communications")
}

model EmailTemplate {
  id          String   @id @default(cuid())
  name        String   @unique
  subject     String
  htmlContent String
  textContent String?
  variables   String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("email_templates")
}

model Notification {
  id        String   @id @default(cuid())
  type      String
  title     String
  message   String
  isRead    Boolean  @default(false)
  data      String?
  userId    String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([type])
  @@map("notifications")
}

model ActivityLog {
  id        String   @id @default(cuid())
  action    String
  timestamp DateTime @default(now())
  userId    String?
  clientId  String?
  details   String?
  client    Client?  @relation(fields: [clientId], references: [id])
  user      User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([clientId])
  @@index([action])
  @@index([timestamp])
  @@map("activity_logs")
}

model Settings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@map("settings")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verificationtokens")
}

model UserSettings {
  id                 String   @id @default(cuid())
  userId             String   @unique
  defaultAssigneeId  String?
  emailNotifications Boolean  @default(true)
  smsNotifications   Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  defaultAssignee    User?    @relation("DefaultAssignee", fields: [defaultAssigneeId], references: [id])
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}
